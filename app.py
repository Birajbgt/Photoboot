quotes = [
    "I took the road less traveled and that has made all the difference.",
    "It's time to plant the seeds of hope and a new, brighter future.",
    "Be bold. Be courageous. Be your best.",
    "I came, I saw, I conquered.",
    "There's no need to try to fit in, when you were born to stand out.",
    "When you lean into your passions, you can't go wrong.",
    "The things we are racing towards are better than what we leave behind.",
    "The future looks bright and I will keep on shining.",
    "This isn't goodbye, but see you later.",
    "The world is your oyster.",
    "May your cap fly as high as your dreams.",
    "Though our branches grow in different directions, our roots remain as one.",
    "And so the adventure begins.",
    "This is the beginning of everything you want.",
    "Once you become fearless, life becomes limitless.",
    "What feels like the end is often the beginning.",
    "If it excites you and scares you at the same time, it probably means you should do it.",
    "The best way to predict the future is to create it.",
    "Not letting anyone or anything stand in my way.",
    "Whatever is good for your soul, that's what you should do.",
    "Every end has a new beginning.",
    "I believed I could, so I did.",
    "If you can dream it, you can make it so.",
    "Can I take a nap now?",
    "I got the skills to pay the bills.",
    "Turns out I wasn't too cool for school.",
    "Let me put that 'hire me' sign on my front lawn now.",
    "Graduate: (N.) A person who now has carpal tunnel from note-taking.",
    "Very proud, very tired.",
    "Cs really do get degrees.",
    "What, like it's hard?",
    "That's all folks.",
    "I already forgot everything.",
    "Beauty and brains.",
    "Cheers to the memories.",
    "Now, who is going to pay off these loans?",
    "Next stop: Adulting",
    "Some graduate with honors, I am just honored to graduate.",
    "I want to thank Google, Wikipedia, and whoever invented copy and paste.",
    "Call me a chemistry cylinder because I am graduated.",
    "Proud of my B.S.",
    "The tassel was worth the hassle.",
    "Now, it's hotter in here by one degree.",
    "Thank you Mom, Dad, and coffee.",
    "I've already forgotten everything.",
    "I owe my degree to coffee.",
    '''I'm 100% certain that I am zero percent sure of what I'm going to do.''',
    "Cap. Gown. It's going down.",
    "I graduated, so now I'm like all smart and stuff.",
    "How lucky I am to have something that makes saying goodbye so hard.",
    "Make today your day.",
    "Now, everything awaits me.",
    "One step closer.",
    "On to my next adventure.",
    "The first step is just showing up.",
    "Enjoy the journey. Success does not rush.",
    "The beauty of the future is found when you believe in yourself.",
    "Take the risk, make the mistake. It'll all be worth it.",
    "I laugh without fear of the future.",
    "All good things must come to an end, but this is just the beginning.",
    "This is what dreams are made of.",
    "Don't cry because it's over. Smile because it happened.",
    "The best feeling in the world is knowing your parents are smiling because of you.",
    "May we continue to do amazing things in life.",
    "Many dream, some try, but I achieved.",
    "Wherever life plants you, bloom with grace.",
    "Dream big, work hard, stay focused, and surround yourself with good people.",
    "Reach for the stars. You might become one.",
    "Never stop dreaming and never lose your spirit.",
    "The best is yet to come.",
    "Thank U, Next.",
    "Watch out for me, I'm bound to glow.",
    "All work and no play never made me lose it. All business all day keeps me up a level.",
    "What didn't break me, made me better.",
    "For every dark night, there's always a brighter day.",
    "What was once in the windshield, is now in my rear view",
    "Always stay gracious, best revenge is your paper.",
    "It was all a dream.",
    "And if at first you don't succeed, dust yourself off and try again.",
    "Before I had it, I closed my eyes and imagined the good life.",
    "Ain't about how fast I get there, ain't about what's waiting on the other side — it's the climb.",
    "And this is the part where you find out who you are.",
    "I don't know where I'm going, but I'm on my way.",
    "There's just no telling how far I'll go.",
    "As we go on, we remember all the times we had together.",
    "Today is where your book begins. The rest is still unwritten.",
    "It's something unpredictable, but in the end it's right, I hope you had the time of your life.",
    "Goodbye to you. Goodbye to everything that I knew.",
    "I wish that I could have this moment for life. The greatest adventure is what lies ahead.",
    "Did everyone see that? Because I will not be doing it again.",
    "Don't tell me the sky's the limit when there are footprints on the moon.",
    "Kid, you'll move mountains.",
    "One isn't necessarily born with courage, but one is born with potential.",
    "Always be a first-rate version of yourself, instead of a second-rate version of somebody else.",
    "If opportunity doesn't knock, build a door.",
    "Education is the key to unlocking the world, a passport to freedom.",
    "It always seems impossible until it's done.",
    "Success is only meaningful and enjoyable if it feels like your own.",
    "Mischief Managed.",
    "She turned her can'ts into cans, and her dreams into plans.",
    "You can never be overdressed or overeducated.",
    "Dream big and dare to fail.",
    "We know what we are but know not what we may be.",
    "If you can imagine it, you can achieve it; if you can dream it, you can become it.",
    "There are far, far better things ahead than any we leave behind.",
    "I took the road less traveled and that has made all the difference.",
    "It's time to plant the seeds of hope and a new, brighter future.",
    "Be bold. Be courageous. Be your best.",
    "I came, I saw, I conquered.",
    "There's no need to try to fit in, when you were born to stand out.",
    "When you lean into your passions, you can't go wrong.",
    "The things we are racing towards are better than what we leave behind.",
    "The future looks bright and I will keep on shining.",
    "This isn't goodbye, but see you later.",
    "The world is your oyster.",
    "May your cap fly as high as your dreams.",
    "Though our branches grow in different directions, our roots remain as one.",
    "And so the adventure begins.",
    "This is the beginning of everything you want.",
    "Once you become fearless, life becomes limitless.",
    "What feels like the end is often the beginning.",
    "If it excites you and scares you at the same time, it probably means you should do it.",
    "The best way to predict the future is to create it.",
    "Not letting anyone or anything stand in my way.",
    "Whatever is good for your soul, that's what you should do.",
    "Every end has a new beginning.",
    "I believed I could, so I did.",
    "If you can dream it, you can make it so.",
    "Finally graduated: My mission for world domination begins now!",
    "Thank you, teachers, for the A's, now off to adulting… Any advice?",
    "Officially graduated from Teacher's Pet Academy with honors!",
    "Four years of relentless studying, but now I'm a professional over-thinker.",
    "I studied for years to learn how to adult. Wish me luck!",
    "They said I wouldn't make it, but here I am… just a bit more refined!",
    "Proof that even rebels can follow a graduation ceremony!",
    "Officially a graduate, and I did it my way - against all odds!",
    "I may have bent a few rules, but I'm standing tall at graduation!",
    "I ran a few laps, tackled some exams, and now I'm crossing the finish line!",
    "From the field to the stage, I made it!",
    "Creativity fueled my studies, and now it's time to color outside the lines of life!",
    "Graduating with a degree in 'Thinking Outside the Box' - Where's my job?",
    "I didn't study much, but I napped like a pro - now graduating with honors!",
    "I might be lazy, but I still managed to graduate. Go figure!",
    "Graduation.exe has successfully executed. Now, where's the WiFi?",
    "I hacked my way through college - now it's time to conquer the real world!",
    "Spent more time making friends than studying, and I have no regrets!",
    "Officially graduated with a degree in 'Socializing and Networking.' Hire me!",
    "I graduated, and now I'm officially too cool for school!",
    "Diploma: Unlocked. Next Level: Adulting!",
    "Goodbye, GPA. Hello, 9-to-5 life!",
    "I used to be the class clown; now I'm just a graduate clown.",
    "Warning: Fully trained to adult, handle with care!",
    "Finally free from textbooks and curfews!",
    "I came, I saw, I graduated. What's next?",
    "Now a certified expert at Googling everything!",
    "I survived college, and all I got was this piece of paper!",
    "Cheers to the end of all-nighters and Ramen noodles!",
    "No more exams, but the test of life begins!",
    "Graduating with a degree in 'Panic Management.'",
    "Four years of Netflix and occasional studying - I made it!",
    "Officially out of student discounts, but I'm still a bargain!",
    "From all-night parties to graduation day - what a journey!",
    "I didn't choose the graduation life; the graduation life chose me!",
    "I'm not a student anymore, but I'll always be a learner.",
    "Turns out, I'm not just a caffeine addict; I'm also a graduate!",
    "I'm not saying I'm the class clown, but I do know how to graduate with a smile!",
    "Life is tough, but so am I - officially graduated!",
    "Bachelor's degree unlocked! Now, who wants to hire a professional student?",
    "Mastered the art of cramming just in time for graduation!",
    "I may have a bachelor's degree, but I'm still a rookie at adulting.",
    "Mastered the syllabus, but still can't figure out taxes!",
    "They say a bachelor's degree opens doors - now, which one leads to the coffee shop?",
    "Just earned my bachelor's degree. Now, where's my cape and superhero name?",
    "Finally, a Bachelor's degree to prove I'm not just good at Netflix.",
    "Mastered the art of student loans. Anyone hiring a debt expert?",
    "Officially a master of procrastination… I mean, education!",
    "From keg parties to cap and gown - quite the transformation!",
    "Bachelor's degree: Because'professional learner isn't a real job.",
    "I may have a bachelor's degree, but I still can't fold a fitted sheet.",
    "Mastered the classroom, now time to master the office coffee machine!",
    "Mastered the books, but still working on mastering adulting.",
    "They say a bachelor's degree is a smart investment. We'll see about that!",
    "Just graduated with a bachelor's degree in 'Avoiding Responsibilities.'",
    "Mastered the fine art of citing sources and making ramen.",
    "Bachelor's degree: A fancy way to say I'm officially unemployed!",
    "I have a bachelor's degree now, but I still can't parallel park.",
    "I survived high school; now I'm ready to conquer the world… or at least college!",
    "Diploma: Unlocked. Next Level: Adulthood!",
    "Goodbye, high school drama. Hello, real-life drama!",
    "From hall passes to graduation, I made it without detention!",
    "Finally free from textbooks and cafeteria food!",
    "College is like a rollercoaster - and I just got off the ride!",
    "I came, I saw, I graduated. What's next?"
]

# Single Frame
import cv2
import mediapipe as mp
import datetime
import numpy as np
import requests
import qrcode
import io
import tempfile
import os
import time
import random
from PIL import Image, ImageDraw, ImageFont

def upload_image_and_generate_qr(cv2_image):
    # Convert the OpenCV image to bytes
    _, im_buf_arr = cv2.imencode('.jpg', cv2_image)
    image_bytes = im_buf_arr.tobytes()

    # Upload the image
    response = requests.post('https://file.io', files={'file': image_bytes})
    
    # Check for successful upload
    if response.status_code == 200 and response.json()['success']:
        # Get the URL of the uploaded image
        image_url = response.json()['link']
        print(f"Image is available at: {image_url}")

        # Generate QR Code for the URL
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=15,
            border=1,
        )
        qr.add_data(image_url)
        qr.make(fit=True)
        qr_img = qr.make_image(fill='black', back_color='white')
        qr_img = qr_img.convert('RGB')

        # Convert PIL Image to OpenCV Image
        qr_open_cv_image = np.array(qr_img) 
        qr_open_cv_image = qr_open_cv_image[:, :, ::-1].copy()  # Convert RGB to BGR
        return qr_open_cv_image
    else:
        raise Exception("Error uploading file")


def cv2_pil_to_cv2(pil_image):
    # Convert a PIL Image into an OpenCV image (in memory)
    open_cv_image = np.array(pil_image) 
    open_cv_image = open_cv_image[:, :, ::-1].copy()  # Convert RGB to BGR
    return open_cv_image


def overlay_qr_code(cv2_image, qr_code_cv2):
    # Size of the QR code
    size = 250  # Increased size for better visibility
    qr_code_resized = cv2.resize(qr_code_cv2, (size, size))
    
    # Position for QR code overlay (bottom-right corner)
    x_offset = cv2_image.shape[1] - size - 20  # 20 pixels from the right edge
    y_offset = 0

    # Overlay QR code
    cv2_image[y_offset:y_offset + size, x_offset:x_offset + size] = qr_code_resized

    # Position for text
    text = "Scan to get Photo"
    font = cv2.FONT_HERSHEY_SIMPLEX
    font_scale = 0.9
    font_thickness = 2
    text_x = x_offset  
    text_y = y_offset + size + 20  # 20 pixels below the QR code

    # Draw the text
    cv2.putText(cv2_image, text, (text_x, text_y), font, font_scale, (0, 0, 255), font_thickness)

    return cv2_image


# Initialize MediaPipe solutions
mp_hands = mp.solutions.hands
mp_face_detection = mp.solutions.face_detection
mp_drawing = mp.solutions.drawing_utils
hands = mp_hands.Hands(min_detection_confidence=0.5, min_tracking_confidence=0.5, max_num_hands = 16)
face_detection = mp_face_detection.FaceDetection()

#for default frame
roi_x2, roi_y2, roi_width2, roi_height2 = 130, 480, 700, 700  # Example coordinates and size
#for second frame
roi_x, roi_y, roi_width, roi_height = 180, 180, 1600,1600  # Example coordinates and size
#for third frame
roi_x3, roi_y3, roi_width3, roi_height3 = 130, 480, 650, 700  # Example coordinates and size
#for fourth frame
roi_x4, roi_y4, roi_width4, roi_height4 = 130, 480, 650, 700  # Example coordinates and size


def is_thumb_extended(thumb_tip, thumb_mcp, other_fingers_mcp):
    # Check if the thumb tip is far from the MCP (metacarpophalangeal joint) of the thumb,
    # and closer to the MCPs of other fingers.
    return thumb_tip.y < thumb_mcp.y and all(thumb_tip.x < finger_mcp.x for finger_mcp in other_fingers_mcp)

def is_finger_folded(finger_tip, finger_mcp):
    # Check if the finger tip is close to its MCP.
    return finger_tip.y > finger_mcp.y

def resize_and_pad_image(image, max_height, side_padding, top_bottom_padding):
    h, w = image.shape[:2]
    scale = max_height / h
    resized_image = cv2.resize(image, (int(w * scale), max_height))

    # Add padding to the sides and top/bottom
    padded_image = cv2.copyMakeBorder(resized_image, top_bottom_padding, top_bottom_padding, 
                                      side_padding, side_padding, cv2.BORDER_CONSTANT, value=[0, 0, 0])
    return padded_image

def set_camera_resolution(cap, width, height):
    cap.set(cv2.CAP_PROP_FRAME_WIDTH, width)
    cap.set(cv2.CAP_PROP_FRAME_HEIGHT, height)

def show_selection_window(image1,stream_window_name, image):
        # Initialize and display progress bar
    progress_bar_length = image.shape[1]
    progress_bar_height = 30
    progress_bar_bg_color = (0, 0, 0)  # Black background
    progress_bar_color = (0, 255, 0)  # Green progress

    def update_progress_bar(progress):
        progress_bar_img = np.zeros((progress_bar_height, progress_bar_length, 3), dtype=np.uint8)
        progress_bar_img[:] = progress_bar_bg_color
        progress_bar_img[:, :int(progress * progress_bar_length)] = progress_bar_color
        return progress_bar_img

    # Show progress bar during QR code generation
    progress = 0.0
    todate = datetime.datetime.now().strftime("%Y%m%d-%H%M%S")
    f1i =  f"images/frame1_{todate}.png"
    cv2.imwrite(f1i, image1)

    max_height = 1000  # Increased max height for better quality
    gap_width = 20  # Width of the gap between images
    side_padding = 240  # Width of the side padding
    top_bottom_padding = 20  # Height of the top and bottom padding

    progress += 0.2
    progress_bar_img = update_progress_bar(progress)
    combined_with_progress = np.vstack((progress_bar_img, image))
    cv2.imshow(stream_window_name, combined_with_progress)
    cv2.waitKey(1)
    # Function to resize image with fixed height, maintaining aspect ratio, and add padding
    def resize_and_pad_image(image, max_height, side_padding, top_bottom_padding):
        h, w = image.shape[:2]
        scale = max_height / h
        resized_image = cv2.resize(image, (int(w * scale), max_height))

        # Add padding to the sides and top/bottom
        padded_image = cv2.copyMakeBorder(resized_image, top_bottom_padding, top_bottom_padding, 
                                          side_padding, side_padding, cv2.BORDER_CONSTANT, value=[0, 0, 0])
        return padded_image

    # Resize and pad the images
    padded_image1 = resize_and_pad_image(image1, max_height, side_padding, top_bottom_padding)
    # padded_image2 = resize_and_pad_image(image2, max_height, side_padding, top_bottom_padding)
    progress += 0.5
    progress_bar_img = update_progress_bar(progress)
    combined_with_progress = np.vstack((progress_bar_img, image))
    cv2.imshow(stream_window_name, combined_with_progress)
    cv2.waitKey(1)
    # Calculate the new height after adding top and bottom padding
    new_height = max_height + 2 * top_bottom_padding

    # Create a gap (blank space) with the new height
    gap = np.zeros((new_height, gap_width, 3), dtype=np.uint8)

    # Combine the padded images with the gap in between
    # combined = np.hstack((padded_image1, gap, padded_image2))
    progress_bar_length = padded_image1.shape[1]

    while progress < 1.0:
        qr_code_image1 = upload_image_and_generate_qr(image1)
        progress += 0.5
        progress_bar_img = update_progress_bar(progress)
        combined_with_progress = np.vstack((progress_bar_img, padded_image1))
        cv2.imshow(stream_window_name, combined_with_progress)
        cv2.waitKey(1)

    while True:
        # Generate a new QR code for image1
        qr_code_image1 = upload_image_and_generate_qr(image1)
        image1_with_qr = overlay_qr_code(image1, qr_code_image1)

        # Resize and pad the image
        padded_image1 = resize_and_pad_image(image1_with_qr, max_height, side_padding, top_bottom_padding)

        # Display the image with the QR code
        cv2.imshow(stream_window_name, padded_image1)
        key = cv2.waitKey(1)

        if key != -1:  # Checks if any key is pressed
            break

    cv2.setWindowProperty(stream_window_name, cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)

    if key == ord('1'):
        return 1
    elif key == ord('2'):
        return 2
    else:
        return None

def classify_gesture(landmarks):
    thumb_tip = landmarks[4]
    thumb_mcp = landmarks[2]
    index_tip = landmarks[8]
    index_mcp = landmarks[5]
    middle_tip = landmarks[12]
    middle_mcp = landmarks[9]
    ring_tip = landmarks[16]
    ring_mcp = landmarks[13]
    little_tip = landmarks[20]
    little_mcp = landmarks[17]

    other_fingers_mcp = [index_mcp, middle_mcp, ring_mcp, little_mcp]

    # Thumbs Up: Thumb extended, other fingers folded
    if is_thumb_extended(thumb_tip, thumb_mcp, other_fingers_mcp) and \
       all(is_finger_folded(finger_tip, finger_mcp) for finger_tip, finger_mcp in 
           [(index_tip, index_mcp), (middle_tip, middle_mcp), (ring_tip, ring_mcp), (little_tip, little_mcp)]):
        return "Thumbs Up"

    # Peace Sign: Index and middle fingers extended, others folded
    if all(not is_finger_folded(finger_tip, finger_mcp) for finger_tip, finger_mcp in 
           [(index_tip, index_mcp), (middle_tip, middle_mcp)]) and \
       all(is_finger_folded(finger_tip, finger_mcp) for finger_tip, finger_mcp in 
           [(ring_tip, ring_mcp), (little_tip, little_mcp)]):
        return "Peace"

    return "Unknown"

def count_faces(image):
    results = face_detection.process(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
    # Draw face detections
    if results.detections:
        for detection in results.detections:
            mp_drawing.draw_detection(image, detection)
        return len(results.detections)
    return 0

last_valid_time = None
countdown_active = False
overlay = cv2.imread('lastframe1.png', -1)
overlay_height, overlay_width = overlay.shape[:2]

def capture_snapshot(image, filename):

    #  # Resize overlay to match the frame size
    # resized_frame = cv2.resize(image, (roi_width, roi_height))
    # # Create a mask for the ROI based on the alpha channel of the overlay
    # roi_mask = overlay[roi_y:roi_y + roi_height, roi_x:roi_x + roi_width, 3] / 255.0
    # roi_mask_inv = 1.0 - roi_mask
    # for c in range(0, 3):
    #         overlay[roi_y:roi_y + roi_height, roi_x:roi_x + roi_width, c] = \
    #             resized_frame[:, :, c] * roi_mask_inv + overlay[roi_y:roi_y + roi_height, roi_x:roi_x + roi_width, c] * roi_mask

    #     # Convert overlay to BGR (dropping alpha channel)
    # final_frame = overlay[:, :, :3]

    # Convert the OpenCV frame to a PIL image
    bar_height = 60  # Adjust the height of the bar as needed
    cv2.rectangle(image, (0, image.shape[0] - bar_height), (image.shape[1], image.shape[0]), (255, 255, 255), -1)

    selected_quote = random.choice(quotes)

    # Choose font for text
    font = cv2.FONT_HERSHEY_SCRIPT_COMPLEX
    font_scale = 1.5  # Adjust font scale as needed
    font_thickness = 3  # Adjust thickness as needed

    # Calculate text size
    text_size, _ = cv2.getTextSize(selected_quote, font, font_scale, font_thickness)

    # Calculate text position for center alignment
    text_x = (image.shape[1] - text_size[0]) // 2
    text_y = image.shape[0] - 20  # Position from the bottom

    # Draw the text
    cv2.putText(image, selected_quote, (text_x, text_y), font, font_scale, (0, 0, 0), font_thickness)

    show_selection_window(image, 'Graduation', image)

    cv2.setWindowProperty('Graduation', cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)


    # Clear the window
    # cv2.destroyAllWindows()

import cv2
import numpy as np
# Load the overlay image (PNG with transparency)
overlay_img = cv2.imread('lastframe1.png', cv2.IMREAD_UNCHANGED)

# Extract the alpha channel from the overlay and create a mask
overlay_alpha = overlay_img[:, :, 3] / 255.0
overlay = overlay_img[:, :, :3]
background_alpha = 1.0 - overlay_alpha

# Resize overlay to desired dimensions if necessary
# For example, if you want the final video to be 640x480
desired_size = ( 1920   ,1080)
overlay = cv2.resize(overlay, desired_size)
overlay_alpha = cv2.resize(overlay_alpha, desired_size)
background_alpha = cv2.resize(background_alpha, desired_size)



# Start video capture
cap = cv2.VideoCapture(0)  # Use 0 for the default camera
cv2.namedWindow('Graduation', cv2.WINDOW_NORMAL)
cv2.setWindowProperty('Graduation', cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)

print("Rendering")
countdown_active = False
last_valid_time = None

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # Resize frame to the same size as overlay
    frame = cv2.resize(frame, desired_size)
    for c in range(0, 3):
        frame[:, :, c] = (overlay_alpha * overlay[:, :, c] +
                          background_alpha * frame[:, :, c])

    width = int(frame.shape[1] * 0.5)
    height = int(frame.shape[0] * 0.5)
    resized_image = cv2.resize(frame, (width, height))
    image_rgb = cv2.cvtColor(resized_image, cv2.COLOR_BGR2RGB)

    # Face detection
    num_faces = count_faces(resized_image)
    print(f"Number of faces: {num_faces}")  # Continuously print the number of faces
    resized_image = cv2.cvtColor(resized_image, cv2.COLOR_BGR2RGB)

    # Hand gesture recognition
    # hand_results = hands.process(image_rgb)
    # valid_gestures = 0
    # current_gestures = []  # List to keep track of current hand gestures
  
    # if hand_results.multi_hand_landmarks:
    #     for hand_landmarks in hand_results.multi_hand_landmarks:
    #         gesture = classify_gesture(hand_landmarks.landmark)
    #         current_gestures.append(gesture)
    #         if gesture in ['Thumbs Up', 'Peace']:
    #             valid_gestures += 1
            # mp_drawing.draw_landmarks(frame, hand_landmarks, mp_hands.HAND_CONNECTIONS)
    # Check for valid shot and start countdown
    # print(current_gestures)

    # Set window to fullscreen again after selection
    cv2.setWindowProperty('Graduation', cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)

    # if not countdown_active and valid_gestures >= num_faces and num_faces > 0:
    #     last_valid_time = datetime.datetime.now()
    #     countdown_active = True
    key = cv2.waitKey(1)
    if key != -1 and key != ord('q'):  # Any key is pressed, other than 'q'
        countdown_active = True
        last_valid_time = datetime.datetime.now()
    if countdown_active:
        elapsed = (datetime.datetime.now() - last_valid_time).total_seconds()
        if elapsed < 3:
            # Display countdown on the screen
            text_to_display = str(3 - int(elapsed))

            # Choose font for text
            font = cv2.FONT_HERSHEY_SIMPLEX
            font_scale = 2.5  # Increased font scale
            font_thickness = 3  # Adjust thickness as needed

            # Calculate text size
            text_size, _ = cv2.getTextSize(text_to_display, font, font_scale, font_thickness)

            # Calculate text position for center alignment
            text_x = (frame.shape[1] - text_size[0]) // 2
            text_y = (frame.shape[0] + text_size[1]) // 2

            # Draw the text
            cv2.putText(frame, text_to_display, (text_x, text_y), font, font_scale, (0, 255, 0), font_thickness, cv2.LINE_AA)
        else:
            # Capture snapshot and reset countdown
            timestamp = datetime.datetime.now().strftime("%Y%m%d-%H%M%S")
            # set_camera_resolution(cap, 2560, 1440)  # 2K resolution
            cv2.imshow('Graduation', frame)
            capture_snapshot(frame, f'snapshot_{timestamp}.png')
            print("Snapshot taken!")
            # set_camera_resolution(cap, 640, 480)
            countdown_active = False

    # Blend the overlay with the frame
    # bar_height = 50  # Adjust the height of the bar as needed
    # cv2.rectangle(frame, (0, frame.shape[0] - bar_height), (frame.shape[1], frame.shape[0]), (0, 0, 0), -1)
    # Display the resulting frame
    cv2.imshow('Graduation', frame)
    # Break the loop on pressing 'q'
    if key == ord('q'):  # Check for 'q' to exit
        break
    cv2.setWindowProperty('Graduation', cv2.WND_PROP_FULLSCREEN, cv2.WINDOW_FULLSCREEN)
# Release everything when done
cap.release()
cv2.destroyAllWindows()